# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 109576 2013-08-17 18:12:27Z gmail.com:christian.frisson $

PortSystem          1.0

name                qt5
conflicts           qt3 qt3-mac qt4-mac qt4-mac-devel
version             5.1.1
set branch          [join [lrange [split ${version} .] 0 1] .]

categories          aqua
platforms           macosx
maintainers         gmail.com:christian.frisson openmaintainer
license             {LGPL-2.1 GPL-3}

homepage            http://qt-project.org
description         Qt Tool Kit
long_description    Qt Tool Kit: A cross-platform framework \
                    (headers, data, and libraries) for writing \
                    cross-platform GUI-based applications.

master_sites        http://download.qt-project.org/official_releases/qt/${branch}/${version}/
distname            qt-mac-opensource-${version}-clang-offline
distfiles           ${distname}.dmg

checksums           sha1    35c99bfc2c622388c2acd7ece64a8b2ee3e37452 \
                    rmd160  5b31a3679fa029e54bc8b3a22198e653b7fcfae3

depends_build       port:p7zip

depends_lib-append  port:zlib path:bin/dbus-daemon:dbus \
                    port:openssl port:tiff \
                    port:libpng port:libmng port:jpeg

extract {
    # A long bash script so that the dmg is always detached
    system "cd ${workpath}; echo attach;hdiutil attach -noverify -mountpoint dmg ${prefix}/var/macports/distfiles/${name}/${distfiles};echo dump;mkdir ${workpath}/files; ${workpath}/dmg/${distname}.app/Contents/MacOS/${distname} --dump-binary-data -i ${workpath}/dmg/${distname}.app/Contents/Resources/installer.dat -o ${workpath}/files;echo extract;7z x -o${workpath} ${workpath}/files/qt*essentials/*essentials.7z;7z x -o${workpath} ${workpath}/files/qt*addons/*addons.7z;echo detach ; hdiutil detach ${workpath}/dmg"
}

use_configure	no

build {}

destroot {

    # Move the binaries to ${destroot}${prefix}/bin
    eval move [glob ${workpath}/${version}/clang_64/bin/*] ${destroot}${prefix}/bin

    # Move the headers to ${destroot}${prefix}/include
    eval move [glob ${workpath}/${version}/clang_64/include/*] ${destroot}${prefix}/include/

    # Move the frameworks to ${destroot}${prefix}/Library/Frameworks/
    xinstall -d ${destroot}${prefix}/Library/Frameworks/
    eval move [glob ${workpath}/${version}/clang_64/lib/*.framework] ${destroot}${prefix}/Library/Frameworks/

    # Move the static libraries to ${destroot}${prefix}/lib
    eval move [glob ${workpath}/${version}/clang_64/lib/*.*] ${destroot}${prefix}/lib/

    # Move the documentation to ${destroot}${prefix}/share/doc/qt5 
    xinstall -d ${destroot}${prefix}/share/doc/qt5
    eval move [glob ${workpath}/${version}/clang_64/doc/*] ${destroot}${prefix}/share/doc/qt5/

    # Move other relevant folders to ${destroot}${prefix}/share/qt5
    xinstall -d ${destroot}${prefix}/share/qt5
    move ${workpath}/${version}/clang_64/examples ${destroot}${prefix}/share/qt5/
    move ${workpath}/${version}/clang_64/imports ${destroot}${prefix}/share/qt5/
    move ${workpath}/${version}/clang_64/mkspecs ${destroot}${prefix}/share/qt5/
    move ${workpath}/${version}/clang_64/phrasebooks ${destroot}${prefix}/share/qt5/
    move ${workpath}/${version}/clang_64/plugins ${destroot}${prefix}/share/qt5/
    move ${workpath}/${version}/clang_64/qml ${destroot}${prefix}/share/qt5/
    move ${workpath}/${version}/clang_64/translations ${destroot}${prefix}/share/qt5/

    # Remove the libqsqlmysql plugin since it requires libmysqlclient.18.dylib
    eval file delete [glob ${destroot}${prefix}/share/qt5/plugins/sqldrivers/libqsqlmysql*]

    # Adjust the dependencies paths and ids using install_name_tool through a bash script	
    system "${portpath}/files/install.sh ${destroot} ${prefix}"

    # Move the app bundles to ${destroot}/Applications/MacPorts/
    xinstall -d ${destroot}/Applications/MacPorts/
    eval move [glob ${destroot}${prefix}/bin/*.app] ${destroot}/Applications/MacPorts/

    # Make sure that qmake finds QT_INSTALL_LIBS
    xinstall ${portpath}/files/qt.conf ${destroot}/${prefix}/bin/qt.conf
    reinplace "s|@@PREFIX@@|${prefix}|g" ${destroot}/${prefix}/bin/qt.conf
}

livecheck.type      regex
livecheck.url       http://releases.qt-project.org/qt5/source
livecheck.regex     "qt-everywhere-opensource-src-(\[0-9a-z.-\]+)${extract.suffix}"
