# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 96206 2012-08-04 00:27:43Z ryandesign@macports.org $

PortSystem          1.0
PortGroup           github 1.0

github.setup        piedar OpenNI2-FreenectDriver 39d282eed7
name                openni2-freenect
version             2.1.0.4
categories          graphics
platforms           darwin
maintainers         christian.frisson@gmail.com openmaintainer
license             LGPL-3+
supported_archs     x86_64

description         APIs for natural interaction devices

long_description    The OpenNI framework provides a set of APIs for accessing \
                    natural interaction devices, including support for voice \
                    and voice command recognition, hand gestures, and body \
                    motion tracking. \
                    This branch contains FreenectDriver, which allows OpenNI2 \
                     to use libfreenect for Kinect support.

checksums           rmd160  2706b37230f695bb33b811f07b8e75debe816ff4 \
                    sha256  43b5741e8ec42459d8c2159c7025d65b5ae66e9c521509b3d84fac79044ded7a

conflicts           openni openni2

depends_build       port:doxygen \
                    port:python27

depends_lib         port:libusb \
                    port:libfreenect

pre-fetch {
    if {${os.platform} == "darwin" && ${os.major} < 10} {
        ui_error "${name} ${version} requires OS X 10.6 or greater."
        return -code error "incompatible OS X version"
    }
}

patchfiles          patch-Source-Drivers-Freenect-Makefile.diff \
                    patch-ThirdParty-PSCommon-BuildSystem-CommonDefs.mak.diff \
                    patch-ThirdParty-PSCommon-BuildSystem-Platform.x86.diff

use_configure       no

variant universal {}

build.cmd           make

post-destroot {
	system "cd ${worksrcpath}/Packaging && ${prefix}/bin/python2.7 Redist.py -platform 64"
   	system "cp -R ${worksrcpath}/Packaging/Output*/Include/*.h ${destroot}${prefix}/include"
   	system "cp -R ${worksrcpath}/Packaging/Output*/Include/Driver ${destroot}${prefix}/include"
   	system "cp -R ${worksrcpath}/Packaging/Output*/Include/Linux-x86 ${destroot}${prefix}/include"
   	system "cp -R ${worksrcpath}/Packaging/Output*/Include/MacOSX ${destroot}${prefix}/include"
   	system "cp -R ${worksrcpath}/Packaging/Output*/Redist/* ${destroot}${prefix}/lib"
   	system "cp -R ${worksrcpath}/Packaging/Output*/Tools/NiViewer ${destroot}${prefix}/bin"
	system "install_name_tool -id ${prefix}/lib/libOpenNI2.dylib ${destroot}${prefix}/lib/libOpenNI2.dylib"
	system "install_name_tool -id ${prefix}/lib/OpenNI2/Drivers/libFreenectDriver.dylib ${destroot}${prefix}/lib/OpenNI2/Drivers/libFreenectDriver.dylib"
	system "install_name_tool -id ${prefix}/lib/OpenNI2/Drivers/libOniFile.dylib ${destroot}${prefix}/lib/OpenNI2/Drivers/libOniFile.dylib"
	system "install_name_tool -id ${prefix}/lib/OpenNI2/Drivers/libPS1080.dylib ${destroot}${prefix}/lib/OpenNI2/Drivers/libPS1080.dylib"
	system "install_name_tool -change libOpenNI2.dylib ${prefix}/lib/libOpenNI2.dylib ${destroot}${prefix}/lib/OpenNI2/Drivers/libFreenectDriver.dylib"
	system "install_name_tool -change libOpenNI2.dylib ${prefix}/lib/libOpenNI2.dylib ${destroot}${prefix}/lib/OpenNI2/Drivers/libOniFile.dylib"
	system "install_name_tool -change libOpenNI2.dylib ${prefix}/lib/libOpenNI2.dylib ${destroot}${prefix}/lib/OpenNI2/Drivers/libPS1080.dylib"
	system "install_name_tool -change libOpenNI2.dylib ${prefix}/lib/libOpenNI2.dylib ${destroot}${prefix}/bin/NiViewer"
}
